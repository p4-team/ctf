//
// This file was generated by the Retargetable Decompiler
// Website: https://retdec.com
// Copyright (c) 2017 Retargetable Decompiler <info@retdec.com>
//

#include <stdbool.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/syslog.h>
#include <time.h>

// ------------------------ Structures ------------------------

struct _IO_FILE {
    int32_t e0;
};

struct tm {
    int32_t e0;
    int32_t e1;
    int32_t e2;
    int32_t e3;
    int32_t e4;
    int32_t e5;
    int32_t e6;
    int32_t e7;
    int32_t e8;
    int32_t e9;
    char * e10;
};

// ------------------- Function Prototypes --------------------

int32_t get_flag(int32_t a1);
int32_t moon_phase(void);

// --------------------- Global Variables ---------------------

int32_t g2 = 0; // LR
bool g3 = false; // R4
int32_t g1 = 0; // 0x9d000

// ------------------------ Functions -------------------------

// Address range: 0x104d8 - 0x10583
int32_t get_flag(int32_t a1) {
    // 0x104d8
    g3 = true;
    struct _IO_FILE * file = fopen("/home/pwn150/flag.txt", "r"); // 0x10504
    int32_t * stream; // 0x10558_0
    if (file == NULL) {
        // 0x10544
        puts("Have a nice day!");
        stream = g3 ? (int32_t *)((int32_t)&g1 + 24) : (int32_t *)24;
        fflush((struct _IO_FILE *)*(int32_t *)*stream);
        exit(0);
        // UNREACHABLE
    }
    int32_t c = fgetc(file); // 0x105281
    if (c == -1) {
        // 0x1053c
        fclose(file);
        // branch -> 0x10544
        // 0x10544
        puts("Have a nice day!");
        stream = g3 ? (int32_t *)((int32_t)&g1 + 24) : (int32_t *)24;
        fflush((struct _IO_FILE *)*(int32_t *)*stream);
        exit(0);
        // UNREACHABLE
    }
    putchar(c);
    int32_t c2 = fgetc(file); // 0x10528
    while (c2 != -1) {
        // 0x1051c
        putchar(c2);
        c2 = fgetc(file);
        // continue -> 0x1051c
    }
    // 0x1053c
    fclose(file);
    // branch -> 0x10544
    // 0x10544
    puts("Have a nice day!");
    stream = g3 ? (int32_t *)((int32_t)&g1 + 24) : (int32_t *)24;
    fflush((struct _IO_FILE *)*(int32_t *)*stream);
    exit(0);
    // UNREACHABLE
}

// Address range: 0x10584 - 0x10793
int32_t moon_phase(void) {
    int32_t time_val = time(NULL); // bp-56
    int32_t time_info = (int32_t)localtime(&time_val); // 0x105a8_3
    int32_t v1;
    int32_t v2 = &v1; // 0x105bc_0
    v1 = *(int32_t *)(time_info + 16);
    *(int32_t *)(v2 + 16) = *(int32_t *)(time_info + 32);
    *(int32_t *)(v2 + 20) = *(int32_t *)(time_info + 36);
    *(int32_t *)(v2 + 24) = *(int32_t *)(time_info + 40);
    if (v1 <= 1) {
        // 0x10600
        // branch -> 0x10618
    }
    // 0x10618
    return (int32_t)0.0 % 8;
}

// Address range: 0x107bc - 0x10b1f
int main(int argc, char ** argv) {
    g3 = true;
    puts("Welcome to our secured moon phase tracking server.");
    int32_t * stream = g3 ? (int32_t *)((int32_t)&g1 + 24) : (int32_t *)24; // 0x107e4_0
    fflush((struct _IO_FILE *)*(int32_t *)*stream);
    int32_t lineptr = 0;
    int32_t v1;
    memset((char *)&v1, 0, 512);
    int32_t v2 = 0;
    int32_t v3 = 0;
    int32_t n = 0;
    puts("What is your name?");
    int32_t * stream2 = g3 ? (int32_t *)((int32_t)&g1 + 24) : (int32_t *)24; // 0x10844_0
    fflush((struct _IO_FILE *)*(int32_t *)*stream2);
    int32_t * v4 = g3 ? (int32_t *)((int32_t)&g1 + 72) : (int32_t *)72; // 0x10858_0
    int32_t stream3 = *(int32_t *)*v4; // 0x1085c
    getline((char **)&lineptr, &n, (struct _IO_FILE *)stream3);
    int32_t str = lineptr; // 0x10870
    *(char *)(str - 1 + strlen((char *)str)) = 0;
    printf("Hello, %s!\n", (char *)lineptr);
    printf("Current moon phase: %d\n", moon_phase());
    int32_t * stream4 = g3 ? (int32_t *)((int32_t)&g1 + 24) : (int32_t *)24; // 0x108cc_0
    fflush((struct _IO_FILE *)*(int32_t *)*stream4);
    if (moon_phase() == 7) {
        // 0x108ec
        get_flag(7);
        // branch -> 0x10904
    } else {
        // 0x108f4
        puts("Sorry, current moon phase is bad for showing flags.");
        // branch -> 0x10904
    }
    int32_t * stream5 = g3 ? (int32_t *)((int32_t)&g1 + 24) : (int32_t *)24; // 0x10908_0
    fflush((struct _IO_FILE *)*(int32_t *)*stream5);
    printf("%s, do you want to leave us a feedback? Enter Y or N:", (char *)lineptr);
    int32_t * stream6 = g3 ? (int32_t *)((int32_t)&g1 + 24) : (int32_t *)24; // 0x10934_0
    fflush((struct _IO_FILE *)*(int32_t *)*stream6);
    scanf("%c", &v2);
    int32_t * stream8; // 0x10ab0_0
    if (v2 % 256 == 89) {
        // 0x1096c
        puts("Please, enter length of your message:");
        int32_t * stream7 = g3 ? (int32_t *)((int32_t)&g1 + 24) : (int32_t *)24; // 0x10980_0
        fflush((struct _IO_FILE *)*(int32_t *)*stream7);
        int32_t v5;
        if (scanf("%5hu%c", &v3, &v5) == 2) {
            // 0x109c0
            if (v5 % 256 == 10) {
                uint32_t v6 = v3; // 0x109e8_0
                if ((int16_t)v6 < 513) {
                    // 0x10a18
                    int32_t str2;
                    snprintf((char *)&str2, 32, "%%%zus", (int64_t)(v6 % 0x10000));
                    scanf((char *)&str2);
                    setlogmask(63);
                    openlog("moonserver", LOG_PID | LOG_CONS | LOG_NDELAY, LOG_LOCAL1);
                    syslog(LOG_NOTICE, "Get new feedback - %s", &v1);
                    puts("Your opinion is very important to us.");
                    closelog();
                    // branch -> 0x10a9c
                } else {
                    // 0x109fc
                    printf("Sorry, %s, your message is too long\n", (char *)lineptr);
                    // branch -> 0x10a9c
                }
                // 0x10a9c
                puts("Bye-bye!");
                stream8 = g3 ? (int32_t *)((int32_t)&g1 + 24) : (int32_t *)24;
                fflush((struct _IO_FILE *)*(int32_t *)*stream8);
                return 0;
            }
        }
        // 0x109cc
        puts("Something went wrong, next time check your input");
        // branch -> 0x10a9c
    }
    // 0x10a9c
    puts("Bye-bye!");
    stream8 = g3 ? (int32_t *)((int32_t)&g1 + 24) : (int32_t *)24;
    fflush((struct _IO_FILE *)*(int32_t *)*stream8);
    return 0;
}

// --------------- Statically Linked Functions ----------------

// void closelog(void);
// void exit(int status);
// int fclose(FILE * stream);
// int fflush(FILE * stream);
// int fgetc(FILE * stream);
// FILE * fopen(const char * restrict filename, const char * restrict modes);
// _IO_ssize_t getline(char ** restrict lineptr, size_t * restrict n, FILE * restrict stream);
// struct tm * localtime(const time_t * timer);
// void * memset(void * s, int c, size_t n);
// void openlog(const char * ident, int option, int facility);
// int printf(const char * restrict format, ...);
// int putchar(int c);
// int puts(const char * s);
// int scanf(const char * restrict format, ...);
// int setlogmask(int mask);
// int snprintf(char * restrict s, size_t maxlen, const char * restrict format, ...);
// size_t strlen(const char * s);
// void syslog(int pri, const char * fmt, ...);
// time_t time(time_t * timer);

// --------------------- Meta-Information ---------------------

// Detected compiler/packer: gcc (6.3.0)
// Detected functions: 3
// Decompiler release: v2.2.1 (2016-09-07)
// Decompilation date: 2017-08-25 22:52:30
